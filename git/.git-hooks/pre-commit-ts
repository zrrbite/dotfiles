#!/bin/bash
# TypeScript/JavaScript pre-commit hook
# Runs formatting check (prettier or oxfmt)

# Check if this is a TypeScript/JavaScript project
if [ ! -f "package.json" ]; then
    exit 0
fi

# Check if there are staged TS/JS files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$')
if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo "Checking TypeScript/JavaScript code formatting..."

# Check if format:check script exists
if ! grep -q '"format:check"' package.json 2>/dev/null; then
    echo "Warning: No format:check script in package.json, skipping format check"
    exit 0
fi

# Run format check
if ! npm run format:check &> /tmp/format-output.txt; then
    echo ""
    echo "╔════════════════════════════════════════════════════════╗"
    echo "║   CODE FORMATTING VIOLATIONS DETECTED!                ║"
    echo "╚════════════════════════════════════════════════════════╝"
    echo ""
    cat /tmp/format-output.txt
    echo ""
    echo "How to fix:"
    echo "  npm run format         # Format all files"
    echo "  git add .              # Re-stage formatted files"
    echo "  git commit             # Try again"
    echo ""
    echo "To bypass (not recommended):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo "✓ All TypeScript/JavaScript files properly formatted"
exit 0
