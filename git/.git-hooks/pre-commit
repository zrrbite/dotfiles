#!/bin/bash
#
# Pre-commit hook to check C++ code formatting with clang-format
# Runs on all staged C++ files and fails if formatting doesn't match .clang-format

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Get list of staged C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|hpp|h|cc|cxx|c)$')

if [ -z "$STAGED_FILES" ]; then
    # No C++ files staged, skip check
    exit 0
fi

echo "Checking C++ code formatting..."

# Run git-clang-format to check if staged changes are formatted
# --diff mode shows what would change, returns non-zero if formatting needed
OUTPUT=$(git clang-format --staged --diff)

# Check if there are formatting issues
if echo "$OUTPUT" | grep -q "no modified files to format" || echo "$OUTPUT" | grep -q "clang-format did not modify any files"; then
    echo -e "${GREEN}✓ All staged C++ files are properly formatted${NC}"
    exit 0
elif echo "$OUTPUT" | grep -q "diff --git"; then
    echo -e "${RED}✗ Formatting issues found in staged C++ files!${NC}"
    echo ""
    echo -e "${YELLOW}The following formatting changes are needed:${NC}"
    echo "$OUTPUT"
    echo ""
    echo -e "${YELLOW}To fix formatting issues, run:${NC}"
    echo "  git clang-format --staged"
    echo "  git add -u"
    echo "  git commit"
    echo ""
    echo -e "${YELLOW}Or to commit anyway (not recommended):${NC}"
    echo "  git commit --no-verify"
    exit 1
else
    # No differences detected or other case
    echo -e "${GREEN}✓ All staged C++ files are properly formatted${NC}"
    exit 0
fi
